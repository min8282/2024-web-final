{% extends 'layout.html' %}

{% block content %}
<div class="post-detail-container">
  <h1>{{ post.title }}</h1>
  <div class="post-images">
    {% for imageUrl in imageUrls %}
      <img src="{{ imageUrl }}" class="post-image" alt="{{ post.title }}">
    {% endfor %}
  </div>
  <div class="post-info">
    <h2>가격정보</h2>
    <p>가격: {{ post.price }}</p>
    <h2>위치정보</h2>
    <p>{{ post.location }}</p>
    <h2>상세설명</h2>
    <p>{{ post.description }}</p>
    <h2>작성자 정보</h2>
    <p>{{ post.User.nick }}</p>
    <button id="show-contact">연락처 보기</button>

    {% if user %}
      <button class="like-button {% if liked %}liked{% endif %}" data-post-id="{{ post.id }}">
        {% if liked %}
          좋아요 취소
        {% else %}
          좋아요
        {% endif %}
      </button>
    {% endif %}

    {% if user and user.id == post.UserId %}
      <div class="post-actions">
        <a href="/post/{{ post.id }}/edit" class="btn">수정하기</a>
        <form action="/post/{{ post.id }}/delete" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?');">
          <button type="submit" class="btn">삭제하기</button>
        </form>
      </div>
    {% endif %}
  </div>
</div>

<!-- 연락처 보기 모달 -->
<div id="contact-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>연락처 정보</h2>
    <p id="contact-nick">이름: {{ post.User.nick }}</p>
    <p id="contact-phone">연락처: {{ post.User.contact }}</p>
  </div>
</div>

<script>
  document.getElementById('show-contact').onclick = function() {
    document.getElementById('contact-modal').style.display = 'block';
  };

  document.querySelector('.close').onclick = function() {
    document.getElementById('contact-modal').style.display = 'none';
  };

  window.onclick = function(event) {
    if (event.target == document.getElementById('contact-modal')) {
      document.getElementById('contact-modal').style.display = 'none';
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    const likeButton = document.querySelector('.like-button');
    if (likeButton) {
      likeButton.addEventListener('click', async () => {
        if (likeButton.disabled) return; // Prevent multiple clicks
        likeButton.disabled = true; // Disable button to prevent multiple clicks

        const postId = likeButton.dataset.postId;
        const isLiked = likeButton.classList.contains('liked');

        try {
          let response;
          if (isLiked) {
            response = await fetch(`/post/${postId}/unlike`, { method: 'DELETE' });
            if (response.ok) {
              likeButton.classList.remove('liked');
              likeButton.textContent = '좋아요';
            } else {
              const error = await response.json();
              alert(error.message);
            }
          } else {
            response = await fetch(`/post/${postId}/like`, { method: 'POST' });
            if (response.ok) {
              likeButton.classList.add('liked');
              likeButton.textContent = '좋아요 취소';
            } else {
              const error = await response.json();
              alert(error.message);
            }
          }
        } catch (error) {
          console.error(error);
        } finally {
          likeButton.disabled = false; // Re-enable button
        }
      });
    }
  });
</script>
{% endblock %}
